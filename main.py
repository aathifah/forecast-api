# -*- coding: utf-8 -*-
"""main

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1mSOpPk7Np7k9JmQa5LyUkjixpPNqvuch
"""

from fastapi import FastAPI, UploadFile, File
from fastapi.responses import FileResponse
import shutil
import os

from model_testing import run_combined_forecast
from model_realtime import run_real_time_forecast

app = FastAPI()

UPLOAD_FOLDER = "uploads"
OUTPUT_TESTING = "uploads/testing_forecast.xlsx"
OUTPUT_REALTIME = "uploads/Forecast_Result.xlsx"

os.makedirs(UPLOAD_FOLDER, exist_ok=True)

@app.post("/run-testing-forecast/")
async def run_testing_forecast(file: UploadFile = File(...)):
    input_path = os.path.join(UPLOAD_FOLDER, file.filename)
    with open(input_path, "wb") as buffer:
        shutil.copyfileobj(file.file, buffer)

    run_combined_forecast(file_path=input_path)

    return FileResponse(
        OUTPUT_TESTING,
        media_type="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
        filename="testing_forecast.xlsx"
    )

@app.get("/run-real-time-forecast/")
def run_realtime():
    run_real_time_forecast(forecast_file=OUTPUT_TESTING)
    return FileResponse(
        OUTPUT_REALTIME,
        media_type="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
        filename="Forecast_Result.xlsx"
    )